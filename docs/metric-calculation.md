# Metric calculation
This section describes how to calculate metrics for the datasets generated by the [OT Platform ETL](https://github.com/opentargets/platform-etl-backend).

The only parameter required for run configuration is the upcoming Open Targets release identifier in the YY.MM format. Its specification is different depending on run mode:
* When running in **pre-ETL mode,** append "_pre", for example: `export OT_RELEASE=23.12_pre`. Release metrics will be processed and uploaded under the same run ID, in this case "23.12".
* When running in **post-ETL mode,** specify release as is, for example: `export OT_RELEASE=23.12`. Because several ETL runs can be made under the same output folder, release timestamp will be autodetected and added to the run ID. For example, if the run was completed on the 26th of October, the post-ETL metrics will appear in the metrics visualisation app as "23.12_2023-10-26".

## Submit job to Dataproc
```bash
export IMAGE=gcr.io/open-targets-eu-dev/ot-release-metrics:latest
export REGION=europe-west1
export BUCKET=gs://ot-release-metrics
gcloud dataproc batches submit pyspark \
    --container-image ${IMAGE} \
    --region ${REGION} \
    --deps-bucket ${BUCKET} \
    --files config/config.yaml \
    --properties "spark.executor.cores=16" \
    src/metric_calculation/metrics.py \
    -- \
    metric_calculation.ot_release=${OT_RELEASE}
```

## Update the Streamlit app
If the Streamlit app was already deployed at the time when the above code was run, it will not be able to automatically pick up the new metrics. Reboot it manually to reflect the new changes. See instructions in the [app documentation](metric-visualisation.md#rebooting-the-app).
